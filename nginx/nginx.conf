worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # Definimos cada réplica
    upstream replica1_backend {
        server replica1:4001;
    }
    upstream replica2_backend {
        server replica2:4002;
    }
    upstream replica3_backend {
        server replica3:4003;
    }

    # Leemos la cookie "replica" del cliente
    map $cookie_replica $replica_backend {
        default "";
        "replica1" "replica1_backend";
        "replica2" "replica2_backend";
        "replica3" "replica3_backend";
    }

    # Si no tiene cookie, asignamos una al azar
    split_clients "${remote_addr}${http_user_agent}" $assigned_replica {
        33.3% "replica1";
        33.3% "replica2";
        *     "replica3";
    }

    server {
        listen 80;

        location / {
            # Si el cliente no tiene cookie, se la damos
            if ($replica_backend = "") {
                add_header Set-Cookie "replica=$assigned_replica; Path=/";
                set $replica_backend "${assigned_replica}_backend";
            }

            # Enruta hacia la réplica que indica la cookie o la recién asignada
            proxy_pass http://$replica_backend;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cookie_path / "/";
            proxy_http_version 1.1;
        }

        # Para debug: misma lógica
        location /debug/ {
            if ($replica_backend = "") {
                add_header Set-Cookie "replica=$assigned_replica; Path=/";
                set $replica_backend "${assigned_replica}_backend";
            }
            proxy_pass http://$replica_backend;
        }
    }
}
